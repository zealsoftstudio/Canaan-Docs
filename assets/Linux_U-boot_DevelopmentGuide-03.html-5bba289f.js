import{_ as t,o as e,c as d,e as o}from"./app-21fd3c9b.js";const n={},i=o(`<h2 id="_4-u-boot-功能及其配置方法-文件介绍" tabindex="-1"><a class="header-anchor" href="#_4-u-boot-功能及其配置方法-文件介绍" aria-hidden="true">#</a> 4 U-Boot 功能及其配置方法/文件介绍</h2><h3 id="_4-1-u-boot-功能介绍" tabindex="-1"><a class="header-anchor" href="#_4-1-u-boot-功能介绍" aria-hidden="true">#</a> 4.1 U-Boot 功能介绍</h3><p>在嵌入式操作系统中，BootLoader/U-Boot 是在操作系统内核运行之前运行。可以初始化硬件设备、建立内存空间映射图，从而将系统的软硬件环境带到一个合适状态，以便为最终调用操作系统内核准备好正确的环境。在 sunxi 平台中，除了必须的引导系统启动功能外，BOOT 系统还提供烧写、升级等其它功能。</p><p>U-Boot 主要功能可以分为以下几类</p><ol><li><p>引导内核</p><p>能从存储介质（nand/mmc/spinor）上加载内核镜像到 DRAM 指定位置并运行。</p></li><li><p>量产 &amp; 升级</p><p>包括卡量产，USB 量产，私有数据烧录，固件升级</p></li><li><p>开机提示信息</p><p>开机能显示启动 logo 图片（BMP 格式)</p></li><li><p>Fastboot 功能</p><p>实现 fastboot 的标准命令，能使用 fastboot 刷机</p></li></ol><h3 id="_4-2-u-boot-功能配置方法介绍" tabindex="-1"><a class="header-anchor" href="#_4-2-u-boot-功能配置方法介绍" aria-hidden="true">#</a> 4.2 U-Boot 功能配置方法介绍</h3><p>U-Boot 中的各项功能可以通过 defconfig 或配置菜单 menuconfig 进行开启或关闭, 具体配置</p><p>方法如下:</p><h4 id="_4-2-1-通过-defconfig-方式配置" tabindex="-1"><a class="header-anchor" href="#_4-2-1-通过-defconfig-方式配置" aria-hidden="true">#</a> 4.2.1 通过 defconfig 方式配置</h4><ol><li><p>vim /longan/brandy/brandy-2.0/u-boot-2018/configs/{LICHEE_CHIP}_defconfig</p></li><li><p>开{LICHEE_CHIP}_defconfig或{LICHEE_CHIP}_nor_defconfig后，在相应的宏定义前去掉或添加&quot;#&quot;即可将相应功能开启或关闭。如下图，只要将CONFIG_SUNXI_NAND前的#去掉即可支持 NAND 相关功能，其他宏定义的开启关闭也类似。修改后需要运行make xxx_defconfig使修改后的配置生效。</p><p><img src="https://cdn.staticaly.com/gh/DongshanPI/Docs-Photos@master/Tina-Sdk/LinuxU-bootDevelopmentGuide_001.png" alt=""></p></li></ol><p>​ 图 4-1: defconfig 配置图</p><h4 id="_4-2-2-通过-menuconfig-方式配置" tabindex="-1"><a class="header-anchor" href="#_4-2-2-通过-menuconfig-方式配置" aria-hidden="true">#</a> 4.2.2 通过 menuconfig 方式配置</h4><p>通过 menuconfig 方式配置的方法步骤如下：</p><ol><li><p>cd brandy/brandy-2.0/u-boot-2018/</p></li><li><p>执行make menuconfig命令，会弹出 menuconfig 配置菜单窗口，如下图所示。此时即可对各模块功能进行配置，配置方法 menuconfig 配置菜单窗口中有说明。</p></li><li><p>修改后配置已经生效，直接 make 即可生成对应 bin。如果重新运行make xxx_defconfig，通过menuconfig 方式修改的配置会在运行make xxx_defconfig后被xxx_defconfig中的配置覆盖。</p></li></ol><p><img src="https://cdn.staticaly.com/gh/DongshanPI/Docs-Photos@master/Tina-Sdk/LinuxU-bootDevelopmentGuide_002.png" alt=""></p><p>​ 图 4-2: menuconfig 配置菜单图</p><h3 id="_4-3-u-boot-配置参数文件介绍" tabindex="-1"><a class="header-anchor" href="#_4-3-u-boot-配置参数文件介绍" aria-hidden="true">#</a> 4.3 U-Boot 配置参数文件介绍</h3><p>U-Boot 自 linux-5.4 以后不再使用 sysconfig 和内核 dts 作为配置文件，而是使用 U-Boot 自带的 dts 来配置参数。kernel-dts 与 U-Boot-dts 完全独立。</p><h4 id="_4-3-1-u-boot-dts-路径" tabindex="-1"><a class="header-anchor" href="#_4-3-1-u-boot-dts-路径" aria-hidden="true">#</a> 4.3.1 U-Boot-dts 路径</h4><p>U-Boot-dts 路径为：vim longan/brandy/brandy-2.0/u-boot-2018/arch/arm/dts</p><h4 id="_4-3-2-u-boot-dts-defconfig-配置" tabindex="-1"><a class="header-anchor" href="#_4-3-2-u-boot-dts-defconfig-配置" aria-hidden="true">#</a> 4.3.2 U-Boot-dts，defconfig 配置</h4><table><thead><tr><th>配置项</th><th>配置项含义</th></tr></thead><tbody><tr><td>CONFIG_OF_SEPARATE</td><td>构建 U-Boot 设备树成为 U-Boot 的一部分</td></tr><tr><td>CONFIG_OF_BOARD</td><td>关闭使用外部 dts</td></tr><tr><td>CONFIG_DEFAULT_DEVICE_TREE</td><td>选择构建的 dts 文件文件名</td></tr><tr><td>CONFIG_SUNXI_NECESSARY_REPLACE_FDT</td><td>开启选项, 实现内部 dts 换成外部 dts</td></tr></tbody></table><table><thead><tr><th>配置项</th><th>选项</th></tr></thead><tbody><tr><td>CONFIG_OF_SEPARATE</td><td>y</td></tr><tr><td>CONFIG_OF_BOARD</td><td>n</td></tr><tr><td>CONFIG_DEFAULT_DEVICE_TREE</td><td>“{LICHEE_CHIP}-soc-system”</td></tr><tr><td>CONFIG_SUNXI_NECESSARY_REPLACE_FDT</td><td>y</td></tr></tbody></table><h4 id="_4-3-3-u-boot-dts-注意事项" tabindex="-1"><a class="header-anchor" href="#_4-3-3-u-boot-dts-注意事项" aria-hidden="true">#</a> 4.3.3 U-Boot-dts 注意事项</h4><h5 id="_4-3-3-1-编译注意事项" tabindex="-1"><a class="header-anchor" href="#_4-3-3-1-编译注意事项" aria-hidden="true">#</a> 4.3.3.1 编译注意事项</h5><p>1.dts 分为板级 dts，和系统 dts。</p><p>系统 dts 由 CONFIG_DEFAULT_DEVICE_TREE 决定，可以在 $(CONFIG_SYS_CONFIG_NAME)_defconfig找到该宏的定义。</p><p>系统 dts 最终会 include 板级 dts，文件路径 {LICHEE_BOARD_CONFIG_DIR}，文件名:uboot-board.dts。</p><ol start="2"><li>我们可以通过编译时的打印判断启动的 dts</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>OBJCOPY examples/standalone/hello_world.srec
OBJCOPY examples/standalone/hello_world.bin
LD u-boot
OBJCOPY u-boot.srec
OBJCOPY u-boot-nodtb.bin
‘{LICHEE_BOARD_CONFIG_DIR}/uboot-board.dts’ -&gt; ‘~/longan/brandy/brandy-2.0/u-boot-2018/
arch/{LICHEE_ARCH}/dts/.board-uboot.dts’
DTC arch/{LICHEE_ARCH}/dts/{LICHEE_CHIP}-soc-system.dtb
SYM u-boot.sym
SHIPPED dts/dt.dtb
FDTGREP dts/dt-spl.dtb
COPY u-boot.dtb
CAT u-boot-dtb.bin
COPY u-boot.bin
‘u-boot.bin’ -&gt; ‘{LICHEE_CHIP}.bin’ ‘u-boot-g{LICHEE_CHIP}.bin’ -&gt; ‘{LICHEE_BRANDY_OUT_DIR}/bin/u-boot-g{LICHEE_CHIP}.bin’ ‘u-boot-g{LICHEE_CHIP}.bin’ -&gt; ‘{LICHEE_PLAT_OUT}/u-boot-g{LICHEE_CHIP}.bin’
CFGCHK u-boot.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-3-3-2-语法注意事项" tabindex="-1"><a class="header-anchor" href="#_4-3-3-2-语法注意事项" aria-hidden="true">#</a> 4.3.3.2 语法注意事项</h5><p>当系统 dts 与板级 dts 存在同路径下同名节点时，板级 dts 将会覆盖系统 dts。</p><h5 id="_4-3-3-3-运行时注意事项" tabindex="-1"><a class="header-anchor" href="#_4-3-3-3-运行时注意事项" aria-hidden="true">#</a> 4.3.3.3 运行时注意事项</h5><ol><li>为了在启动内核前更新参数到内核 dts 和可以在 U-Boot 控制台查看修改 dts。按阶段划分可以分为使用内部 dts 阶段和使用内核 dts 阶段，如下图所示。</li></ol><p><img src="https://cdn.staticaly.com/gh/DongshanPI/Docs-Photos@master/Tina-Sdk/LinuxU-bootDevelopmentGuide_003.png" alt=""></p><p>​ 图 4-3: dts 变化图</p><ol start="2"><li>可以通过命令set_working_fdt来切换当前生效的 fdt。</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[04.562]update bootcmd
[04.576]change working_fdt 0x7bebee58 to 0x7be8ee58
[04.587]update dts
Hit any key to stop autoboot: 0
=&gt; set
	set_working_fdt setenv setexpr
=&gt; set_working_fdt 0x7bebee58
change working_fdt 0x7be8ee58 to 0x7bebee58
=&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,38),a=[i];function s(r,l){return e(),d("div",null,a)}const b=t(n,[["render",s],["__file","Linux_U-boot_DevelopmentGuide-03.html.vue"]]);export{b as default};
